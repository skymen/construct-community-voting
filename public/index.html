<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Construct Community Voting</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-pink: #dc0d8a;
        --primary-pink-dark: #b50a72;
        --primary-purple: #b721ff;
        --primary-cyan: #21d4fd;
        --discord-blurple: #5865f2;
        --discord-blurple-dark: #4752c4;
        --bg-white: #ffffff;
        --bg-light: #f8f9fa;
        --text-dark: #2b2b2b;
        --text-gray: #666666;
        --text-light: #999999;
        --border-light: #e0e0e0;
        --success: #4caf50;
        --warning: #ff9800;
        --project-avatar-bg: #2b2b2b;
        --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.08);
        --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Roboto", Arial, sans-serif;
        background: var(--bg-light);
        color: var(--text-dark);
        line-height: 1.75;
        font-weight: 300;
        letter-spacing: 0.01em;
        min-height: 100vh;
        padding-top: 64px;
      }

      /* Top Navigation Bar */
      .top-nav {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 64px;
        background: linear-gradient(to right, #213140, #203a43, #213140);
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.22);
        z-index: 1000;
        display: flex;
        align-items: center;
        padding: 0 1.5rem;
      }

      .nav-content {
        max-width: 1600px;
        width: 100%;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .nav-brand {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        text-decoration: none;
      }

      .nav-logo {
        width: 40px;
        height: 40px;
      }

      .nav-title {
        font-size: 1.25rem;
        font-weight: 500;
        color: white;
      }

      .nav-user {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .nav-user-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: white;
      }

      .nav-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.75rem;
        color: white;
      }

      .nav-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
      }

      .nav-username {
        font-weight: 500;
        color: white;
      }

      .btn-nav {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        border-radius: 6px;
      }

      .btn-nav-discord {
        background: var(--discord-blurple);
        color: white;
        border: none;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-family: inherit;
        font-weight: 500;
        transition: background 0.2s;
      }

      .btn-nav-discord:hover {
        background: var(--discord-blurple-dark);
      }

      .btn-nav-logout {
        background: transparent;
        color: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.3);
        cursor: pointer;
        font-family: inherit;
        font-weight: 500;
        transition: all 0.2s;
      }

      .btn-nav-logout:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .nav-status {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 50px;
        background: rgba(76, 175, 80, 0.2);
        color: #81c784;
        border: 1px solid rgba(76, 175, 80, 0.4);
      }

      .nav-status.ineligible {
        background: rgba(244, 67, 54, 0.2);
        color: #ef9a9a;
        border-color: rgba(244, 67, 54, 0.4);
      }

      .nav-status.voted {
        background: rgba(88, 101, 242, 0.2);
        color: #a5b4fc;
        border-color: rgba(88, 101, 242, 0.4);
      }

      /* Header section with Construct gradient */
      .hero-section {
        background: linear-gradient(-20deg, #b721ff 0%, #21d4fd 100%);
        padding: 2rem 1.5rem 3rem;
        position: relative;
        overflow: hidden;
      }

      .hero-section::after {
        content: "";
        position: absolute;
        bottom: -50px;
        left: 0;
        right: 0;
        height: 100px;
        background: var(--bg-light);
        transform: skewY(-2deg);
      }

      .hero-content {
        max-width: 1600px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
        text-align: center;
        color: white;
        padding-bottom: 2rem;
      }

      h1 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .subtitle {
        font-size: 1.125rem;
        opacity: 0.9;
        font-weight: 300;
      }

      /* Stats in hero */
      .hero-stats {
        display: flex;
        justify-content: center;
        gap: 3rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
      }

      .stat {
        text-align: center;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        display: block;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .stat-label {
        font-size: 0.75rem;
        opacity: 0.85;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-top: 0.25rem;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        font-family: inherit;
        font-size: 0.9375rem;
        font-weight: 500;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-vote {
        background: var(--primary-pink);
        color: white;
        padding: 0.625rem 1.25rem;
        font-size: 0.875rem;
        box-shadow: 0 4px 15px rgba(220, 13, 138, 0.3);
      }

      .btn-vote:hover:not(:disabled) {
        background: var(--primary-pink-dark);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(220, 13, 138, 0.4);
      }

      .btn-vote:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-voted {
        background: var(--success);
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }

      /* Main content area with sidebar */
      .main-layout {
        max-width: 1600px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
        position: relative;
        z-index: 2;
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 2rem;
        align-items: start;
      }

      .main-content {
        min-width: 0;
      }

      .sidebar {
        position: sticky;
        top: 80px;
        max-height: calc(100vh - 96px);
        overflow-y: auto;
      }

      /* Loading */
      .loading {
        text-align: center;
        padding: 4rem 2rem;
        font-size: 1rem;
        color: var(--text-gray);
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-light);
        border-top-color: var(--primary-pink);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Error */
      .error {
        background: #fff5f5;
        border: 1px solid #ffcdd2;
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        color: #c62828;
      }

      /* Projects grid */
      .projects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 1.5rem;
      }

      .project-spacer {
        flex: 1;
      }

      .project-card {
        background: var(--bg-white);
        border: 1px solid var(--border-light);
        border-radius: 16px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      .project-card:hover {
        box-shadow: var(--shadow-hover);
        transform: translateY(-4px);
        border-color: var(--primary-pink);
      }

      .project-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .project-avatar {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.25rem;
        color: white;
        flex-shrink: 0;
      }

      .project-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 12px;
      }

      .project-name {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 0.125rem;
        line-height: 1;
      }

      .project-slug {
        font-size: 0.8125rem;
        color: var(--text-light);
      }

      .project-description {
        color: var(--text-gray);
        line-height: 1.6;
        font-size: 0.9375rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .project-meta {
        display: flex;
        gap: 1.5rem;
        margin-bottom: 1rem;
        padding: 1rem 0;
        border-top: 1px solid var(--border-light);
        border-bottom: 1px solid var(--border-light);
      }

      .meta-item {
        display: flex;
        flex-direction: column;
      }

      .meta-label {
        font-size: 0.6875rem;
        color: var(--text-light);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .meta-value {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-top: 0.125rem;
      }

      .project-tags {
        display: flex;
        gap: 0.375rem;
        flex-wrap: wrap;
        margin-bottom: 0.5rem;
      }

      .tag {
        font-size: 0.625rem;
        padding: 0.125rem 0.5rem;
        background: var(--bg-light);
        border: 1px solid var(--border-light);
        border-radius: 50px;
        color: var(--text-light);
        text-transform: lowercase;
        letter-spacing: 0.02em;
      }

      .project-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .project-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        color: var(--text-gray);
        text-decoration: none;
        font-size: 0.8125rem;
        transition: color 0.2s ease;
      }

      .project-link:hover {
        color: var(--primary-pink);
      }

      .project-link img {
        width: 16px;
        height: 16px;
      }

      .vote-count {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        color: var(--text-gray);
        font-size: 0.875rem;
      }

      .vote-count img {
        width: 18px;
        height: 18px;
      }

      .vote-count strong {
        color: var(--text-dark);
        font-weight: 700;
      }

      .project-vote-section {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-light);
      }

      /* Results section - Sidebar */
      .results-section {
        padding: 1.25rem;
        background: var(--bg-white);
        border-radius: 16px;
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--border-light);
      }

      .results-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-light);
      }

      .results-header img {
        width: 24px;
        height: 24px;
      }

      .results-header h2 {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0;
      }

      .results-month {
        font-size: 0.75rem;
        color: var(--text-light);
        margin-top: 0.125rem;
      }

      .results-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .result-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: var(--bg-light);
        border: 1px solid var(--border-light);
        border-radius: 10px;
        transition: all 0.2s ease;
      }

      .result-item:hover {
        border-color: var(--primary-pink);
      }

      .result-rank {
        width: 28px;
        height: 28px;
        background: #ffd700;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.75rem;
        color: #2b2b2b;
        flex-shrink: 0;
      }

      .result-rank.rank-2 {
        background: #c0c0c0;
        color: #2b2b2b;
      }

      .result-rank.rank-3 {
        background: #cd7f32;
        color: white;
      }

      .result-rank.rank-other {
        background: #e0e0e0;
        color: #666666;
      }

      .result-info {
        flex: 1;
        min-width: 0;
      }

      .result-name {
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--text-dark);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .result-votes {
        font-size: 0.75rem;
        color: var(--text-gray);
      }

      .result-bar {
        height: 4px;
        background: var(--border-light);
        border-radius: 2px;
        margin-top: 0.375rem;
        overflow: hidden;
      }

      .result-bar-fill {
        height: 100%;
        background: var(--primary-pink);
        border-radius: 2px;
        transition: width 0.5s ease;
      }

      .btn-remove-vote {
        background: transparent;
        color: #f44336;
        border: 1px solid #f44336;
        padding: 0.5rem 1rem;
        font-size: 0.8125rem;
        margin-left: 0.5rem;
      }

      .btn-remove-vote:hover {
        background: #f44336;
        color: white;
      }

      .vote-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      /* Toast notifications */
      .toast {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--bg-white);
        border: 1px solid var(--border-light);
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }

      .toast.success {
        border-left: 4px solid var(--success);
      }

      .toast.error {
        border-left: 4px solid #f44336;
      }

      .toast img {
        width: 24px;
        height: 24px;
      }

      /* No projects */
      .no-projects {
        text-align: center;
        padding: 4rem 2rem;
        font-size: 1rem;
        color: var(--text-gray);
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .main-layout {
          grid-template-columns: 1fr;
        }

        .sidebar {
          position: static;
          max-height: none;
        }
      }

      @media (max-width: 768px) {
        body {
          padding-top: 56px;
        }

        .top-nav {
          height: 56px;
          padding: 0 1rem;
        }

        .nav-title {
          font-size: 1rem;
        }

        .nav-status {
          display: none;
        }

        h1 {
          font-size: 1.5rem;
        }

        .hero-stats {
          gap: 1.5rem;
        }

        .projects-grid {
          grid-template-columns: 1fr;
        }

        .project-meta {
          gap: 1rem;
        }

        .hero-section {
          padding: 1.5rem 1rem 2rem;
        }
      }

      /* Discord icon */
      .discord-icon {
        width: 20px;
        height: 20px;
      }

      /* Icon styling */
      .icon {
        width: 20px;
        height: 20px;
      }
    </style>
  </head>
  <body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
      <div class="nav-content">
        <a href="/" class="nav-brand">
          <img
            src="./assets/construct-3-logo_v43.png"
            alt="Construct"
            class="nav-logo"
            onerror="this.style.display='none'"
          />
          <span class="nav-title">Construct Community</span>
        </a>
        <div class="nav-user" id="nav-user">
          <!-- User info or login button will be inserted here -->
        </div>
      </div>
    </nav>

    <div class="hero-section">
      <div class="hero-content">
        <h1>Community Project Voting</h1>
        <p class="subtitle">
          Vote once per month to allocate community funds to your favorite
          project
        </p>

        <div class="hero-stats">
          <div class="stat">
            <span class="stat-value" id="project-count">—</span>
            <span class="stat-label">Active Projects</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="total-balance">—</span>
            <span class="stat-label">Available Balance</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="vote-count">—</span>
            <span class="stat-label">Votes This Month</span>
          </div>
        </div>
      </div>
    </div>

    <div class="main-layout">
      <div class="main-content">
        <div id="content">
          <div class="loading">
            <div class="loading-spinner"></div>
            Loading projects...
          </div>
        </div>
      </div>

      <aside class="sidebar">
        <div class="results-section" id="results-section" style="display: none">
          <div class="results-header">
            <img src="./assets/crown.svg" alt="Results" />
            <div>
              <h2>Current Results</h2>
              <div class="results-month" id="results-month"></div>
            </div>
          </div>
          <div class="results-list" id="results-list">
            <!-- Results will be inserted here -->
          </div>
        </div>
      </aside>
    </div>

    <div class="toast" id="toast">
      <img src="./assets/tick.svg" alt="" class="toast-icon" />
      <span class="toast-message"></span>
    </div>

    <script>
      const API_ENDPOINT = "https://api.opencollective.com/graphql/v2";
      const COLLECTIVE_SLUG = "construct-community";

      let currentUser = null;
      let hasVotedThisMonth = false;
      let currentVote = null;
      let monthlyResults = {};
      let allProjects = [];

      // Initialize
      document.addEventListener("DOMContentLoaded", async () => {
        updateVotingPeriod();
        await checkAuth();
        await Promise.all([fetchProjects(), fetchVoteResults()]);
      });

      function updateVotingPeriod() {
        const now = new Date();
        const monthName = now.toLocaleString("default", {
          month: "long",
          year: "numeric",
        });
        const resultsMonth = document.getElementById("results-month");
        if (resultsMonth) {
          resultsMonth.textContent = monthName;
        }
      }

      async function checkAuth() {
        try {
          const response = await fetch("/api/me");
          const data = await response.json();

          if (data.authenticated) {
            currentUser = data.user;
            hasVotedThisMonth = data.hasVotedThisMonth;
            currentVote = data.currentVote;
            renderUserSection();
          } else {
            renderLoginButton();
          }
        } catch (err) {
          console.error("Auth check failed:", err);
          renderLoginButton();
        }
      }

      function renderLoginButton() {
        const navUser = document.getElementById("nav-user");
        navUser.innerHTML = `
          <a href="/auth/discord" class="btn-nav btn-nav-discord">
            <svg class="discord-icon" viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
              <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
            </svg>
            Login with Discord
          </a>
        `;
      }

      function renderUserSection() {
        const navUser = document.getElementById("nav-user");
        const avatarUrl = currentUser.avatar
          ? `https://cdn.discordapp.com/avatars/${currentUser.id}/${currentUser.avatar}.png`
          : null;

        let statusClass = "";
        let statusText = "";
        if (!currentUser.isGuildMember) {
          statusClass = "ineligible";
          statusText = "Not a member";
        } else if (!currentUser.hasRequiredRole) {
          statusClass = "ineligible";
          statusText = "Missing role";
        } else if (hasVotedThisMonth) {
          statusClass = "voted";
          statusText = "Voted ✓";
        } else {
          statusClass = "";
          statusText = "Can vote";
        }

        navUser.innerHTML = `
          <span class="nav-status ${statusClass}">${statusText}</span>
          <div class="nav-user-info">
            <div class="nav-avatar">
              ${
                avatarUrl
                  ? `<img src="${avatarUrl}" alt="${currentUser.username}">`
                  : currentUser.username.charAt(0).toUpperCase()
              }
            </div>
            <span class="nav-username">${currentUser.username}</span>
          </div>
          <button class="btn-nav btn-nav-logout" onclick="logout()">Logout</button>
        `;
      }

      async function logout() {
        try {
          await fetch("/auth/logout", { method: "POST" });
          currentUser = null;
          hasVotedThisMonth = false;
          renderLoginButton();
          await fetchProjects();
        } catch (err) {
          console.error("Logout failed:", err);
        }
      }

      async function fetchProjects() {
        const query = `
          query($slug: String!) {
            account(slug: $slug) {
              name
              slug
              description
              imageUrl
              stats {
                balance {
                  valueInCents
                  currency
                }
              }
              childrenAccounts(accountType: PROJECT, isActive: true) {
                totalCount
                nodes {
                  id
                  name
                  slug
                  description
                  imageUrl
                  tags
                  isActive
                  isArchived
                  createdAt
                  stats {
                    balance {
                      valueInCents
                      currency
                    }
                    totalAmountReceived {
                      valueInCents
                      currency
                    }
                  }
                  members(role: BACKER) {
                    totalCount
                  }
                }
              }
            }
          }
        `;

        try {
          const response = await fetch(API_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              query,
              variables: { slug: COLLECTIVE_SLUG },
            }),
          });

          const result = await response.json();

          if (result.errors) {
            throw new Error(result.errors[0].message);
          }

          renderProjects(result.data.account);
        } catch (error) {
          console.error("Error fetching projects:", error);
          showError(error);
        }
      }

      async function fetchVoteResults() {
        try {
          const response = await fetch("/api/votes/current");
          const data = await response.json();
          monthlyResults = data.results;
          updateVoteCount();
          renderResults();
        } catch (err) {
          console.error("Error fetching vote results:", err);
        }
      }

      function updateVoteCount() {
        const totalVotes = Object.values(monthlyResults).reduce(
          (sum, p) => sum + p.count,
          0
        );
        document.getElementById("vote-count").textContent = totalVotes;
      }

      function formatCurrency(valueInCents, currency) {
        const value = valueInCents / 100;
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: currency || "USD",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        }).format(value);
      }

      function getInitials(name) {
        return name
          .split(" ")
          .map((word) => word[0])
          .slice(0, 2)
          .join("")
          .toUpperCase();
      }

      function renderProjects(accountData) {
        const contentDiv = document.getElementById("content");
        const projects = accountData.childrenAccounts.nodes;

        // Store projects for results
        allProjects = projects;

        // Update stats
        document.getElementById("project-count").textContent = projects.length;

        // Use collective's own balance (not allocated to projects)
        const collectiveBalance = accountData.stats?.balance?.valueInCents || 0;
        const collectiveCurrency =
          accountData.stats?.balance?.currency || "USD";
        document.getElementById("total-balance").textContent = formatCurrency(
          collectiveBalance,
          collectiveCurrency
        );

        if (projects.length === 0) {
          contentDiv.innerHTML =
            '<div class="no-projects">No active projects found.</div>';
          return;
        }

        const projectsHTML = projects
          .map((project) => {
            const balance = project.stats?.balance?.valueInCents || 0;
            const currency = project.stats?.balance?.currency || "USD";
            const totalReceived =
              project.stats?.totalAmountReceived?.valueInCents || 0;
            const backers = project.members?.totalCount || 0;
            const tags = project.tags || [];
            const projectVotes = monthlyResults[project.slug]?.count || 0;
            const isVotedProject = currentVote?.projectSlug === project.slug;

            let voteSection = "";
            if (currentUser && currentUser.hasRequiredRole) {
              if (hasVotedThisMonth && isVotedProject) {
                voteSection = `
                  <div class="vote-actions">
                    <button class="btn btn-vote btn-voted" disabled>
                      <img src="./assets/tick.svg" alt="" style="width:16px;height:16px;filter:brightness(0) invert(1);">
                      Your Vote
                    </button>
                    <button class="btn btn-remove-vote" onclick="removeVote()">
                      Remove Vote
                    </button>
                  </div>`;
              } else if (hasVotedThisMonth) {
                voteSection = `
                  <button class="btn btn-vote" disabled style="opacity: 0.5;">
                    Already voted
                  </button>`;
              } else {
                voteSection = `
                  <button class="btn btn-vote" onclick="vote('${
                    project.slug
                  }', '${project.name.replace(/'/g, "\\'")}')">
                    <img src="./assets/favorite.svg" alt="" style="width:16px;height:16px;filter:brightness(0) invert(1);">
                    Vote for this
                  </button>`;
              }
            }

            return `
              <div class="project-card">
                <div class="project-header">
                  <div class="project-avatar">
                    ${
                      project.imageUrl
                        ? `<img src="${project.imageUrl}" alt="${project.name}">`
                        : getInitials(project.name)
                    }
                  </div>
                  <div class="project-info">
                    <div class="project-name">${project.name}</div>
                    <div class="project-slug">@${project.slug}</div>
                  </div>
                </div>
                
                ${
                  project.description
                    ? `<div class="project-description">${project.description}</div>`
                    : ""
                }

                ${
                  tags.length > 0
                    ? `
                  <div class="project-tags">
                    ${tags
                      .slice(0, 3)
                      .map((tag) => `<span class="tag">${tag}</span>`)
                      .join("")}
                  </div>
                `
                    : ""
                }
                <div class="project-spacer"></div>
                <div class="project-meta">
                  <div class="meta-item">
                    <span class="meta-label">Balance</span>
                    <span class="meta-value">${formatCurrency(
                      balance,
                      currency
                    )}</span>
                  </div>
                  <div class="meta-item">
                    <span class="meta-label">Received</span>
                    <span class="meta-value">${formatCurrency(
                      totalReceived,
                      currency
                    )}</span>
                  </div>
                  <div class="meta-item">
                    <span class="meta-label">Backers</span>
                    <span class="meta-value">${backers}</span>
                  </div>
                </div>
                
                <div class="project-footer">
                  <a href="https://opencollective.com/${project.slug}" 
                     target="_blank" 
                     rel="noopener noreferrer" 
                     class="project-link">
                    <img src="./assets/right-arrow.svg" alt="">
                    View on Open Collective
                  </a>
                  <div class="vote-count">
                    <img src="./assets/favorite.svg" alt="Votes">
                    <strong>${projectVotes}</strong> vote${
              projectVotes !== 1 ? "s" : ""
            }
                  </div>
                </div>
                
                ${
                  voteSection
                    ? `<div class="project-vote-section">${voteSection}</div>`
                    : ""
                }
              </div>
            `;
          })
          .join("");

        contentDiv.innerHTML = `<div class="projects-grid">${projectsHTML}</div>`;

        // Re-render results with all projects
        renderResults();
      }

      async function vote(projectSlug, projectName) {
        if (!currentUser || !currentUser.hasRequiredRole || hasVotedThisMonth) {
          return;
        }

        try {
          const response = await fetch("/api/vote", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ projectSlug, projectName }),
          });

          const data = await response.json();

          if (response.ok) {
            hasVotedThisMonth = true;
            currentVote = { projectSlug, projectName };
            monthlyResults = data.results;
            showToast(`Successfully voted for ${projectName}!`, "success");
            renderUserSection();
            await fetchProjects();
            updateVoteCount();
          } else {
            showToast(data.error || "Failed to record vote", "error");
          }
        } catch (err) {
          console.error("Vote failed:", err);
          showToast("Failed to record vote. Please try again.", "error");
        }
      }

      async function removeVote() {
        if (!currentUser || !hasVotedThisMonth) {
          return;
        }

        try {
          const response = await fetch("/api/vote", {
            method: "DELETE",
          });

          const data = await response.json();

          if (response.ok) {
            const removedProject = currentVote?.projectName || "the project";
            hasVotedThisMonth = false;
            currentVote = null;
            monthlyResults = data.results;
            showToast(`Vote for ${removedProject} removed.`, "success");
            renderUserSection();
            await fetchProjects();
            updateVoteCount();
          } else {
            showToast(data.error || "Failed to remove vote", "error");
          }
        } catch (err) {
          console.error("Remove vote failed:", err);
          showToast("Failed to remove vote. Please try again.", "error");
        }
      }

      function renderResults() {
        const resultsSection = document.getElementById("results-section");
        const resultsList = document.getElementById("results-list");

        // Include all projects, even those with 0 votes
        const allProjectResults = allProjects.map((project) => {
          const voteData = monthlyResults[project.slug];
          return {
            slug: project.slug,
            projectName: project.name,
            count: voteData?.count || 0,
            voters: voteData?.voters || [],
          };
        });

        // Sort by vote count (descending), then by name (ascending)
        const sortedResults = allProjectResults.sort((a, b) => {
          if (b.count !== a.count) return b.count - a.count;
          return a.projectName.localeCompare(b.projectName);
        });

        if (sortedResults.length === 0) {
          resultsSection.style.display = "none";
          return;
        }

        resultsSection.style.display = "block";

        // Update month display
        updateVotingPeriod();

        const maxVotes = sortedResults[0]?.count || 1;

        resultsList.innerHTML = sortedResults
          .map((result, index) => {
            const percentage =
              maxVotes > 0 ? (result.count / maxVotes) * 100 : 0;
            let rankClass = "";
            if (index === 0) rankClass = "";
            else if (index === 1) rankClass = "rank-2";
            else if (index === 2) rankClass = "rank-3";
            else rankClass = "rank-other";

            return `
              <div class="result-item">
                <div class="result-rank ${rankClass}">${index + 1}</div>
                <div class="result-info">
                  <div class="result-name">${result.projectName}</div>
                  <div class="result-votes">${result.count} vote${
              result.count !== 1 ? "s" : ""
            }</div>
                  <div class="result-bar">
                    <div class="result-bar-fill" style="width: ${percentage}%"></div>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      function showError(error) {
        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
          <div class="error">
            <h2>Error Loading Projects</h2>
            <p>${error.message}</p>
          </div>
        `;
      }

      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        const icon = toast.querySelector(".toast-icon");
        const msgSpan = toast.querySelector(".toast-message");

        if (type === "success") {
          icon.src = "./assets/tick.svg";
        } else {
          icon.src = "./assets/close.svg";
        }

        msgSpan.textContent = message;
        toast.className = `toast ${type} show`;

        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      // Check for OAuth errors in URL
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has("error")) {
        const error = urlParams.get("error");
        let message = "Authentication failed";
        if (error === "oauth_denied")
          message = "Discord authorization was denied";
        else if (error === "token_error")
          message = "Failed to get access token";
        else if (error === "oauth_error")
          message = "OAuth authentication error";

        showToast(message, "error");
        window.history.replaceState({}, document.title, "/");
      }
    </script>
  </body>
</html>
