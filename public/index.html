<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Construct Community Voting</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --primary-orange: #ff6b35;
        --primary-orange-dark: #e55a2b;
        --primary-blue: #1e3a8a;
        --discord-blurple: #5865F2;
        --discord-blurple-dark: #4752c4;
        --bg-dark: #0f1419;
        --bg-card: #1a1f2e;
        --bg-card-hover: #232938;
        --text-white: #ffffff;
        --text-light: #e2e8f0;
        --text-muted: #94a3b8;
        --border-dark: #2d3748;
        --success: #22c55e;
        --warning: #f59e0b;
        --error: #ef4444;
        --gradient-warm: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        --gradient-cool: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg-dark);
        color: var(--text-light);
        line-height: 1.6;
        min-height: 100vh;
      }

      /* Animated background */
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
          radial-gradient(ellipse at 20% 20%, rgba(255, 107, 53, 0.08) 0%, transparent 50%),
          radial-gradient(ellipse at 80% 80%, rgba(88, 101, 242, 0.08) 0%, transparent 50%),
          radial-gradient(ellipse at 50% 50%, rgba(118, 75, 162, 0.05) 0%, transparent 70%);
        pointer-events: none;
        z-index: 0;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
        position: relative;
        z-index: 1;
      }

      /* Header */
      header {
        text-align: center;
        margin-bottom: 3rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid var(--border-dark);
      }

      .logo-section {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .logo {
        width: 56px;
        height: 56px;
        background: var(--gradient-warm);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        box-shadow: 0 4px 20px rgba(255, 107, 53, 0.3);
      }

      h1 {
        font-size: 2.75rem;
        font-weight: 700;
        background: var(--gradient-warm);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .subtitle {
        font-size: 1.125rem;
        color: var(--text-muted);
        font-weight: 300;
      }

      /* User section */
      .user-section {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: var(--bg-card);
        padding: 0.5rem 1rem 0.5rem 0.5rem;
        border-radius: 50px;
        border: 1px solid var(--border-dark);
      }

      .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--gradient-cool);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
      }

      .user-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
      }

      .user-name {
        font-weight: 500;
        color: var(--text-white);
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        font-family: inherit;
        font-size: 0.9375rem;
        font-weight: 500;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn-discord {
        background: var(--discord-blurple);
        color: white;
      }

      .btn-discord:hover {
        background: var(--discord-blurple-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(88, 101, 242, 0.4);
      }

      .btn-logout {
        background: transparent;
        color: var(--text-muted);
        border: 1px solid var(--border-dark);
      }

      .btn-logout:hover {
        background: var(--bg-card);
        color: var(--text-white);
      }

      .btn-vote {
        background: var(--gradient-warm);
        color: white;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
      }

      .btn-vote:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(255, 107, 53, 0.4);
      }

      .btn-vote:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-voted {
        background: var(--success);
        cursor: default;
      }

      /* Status badges */
      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.875rem;
        border-radius: 50px;
        font-size: 0.8125rem;
        font-weight: 500;
      }

      .status-eligible {
        background: rgba(34, 197, 94, 0.15);
        color: var(--success);
        border: 1px solid rgba(34, 197, 94, 0.3);
      }

      .status-ineligible {
        background: rgba(239, 68, 68, 0.15);
        color: var(--error);
        border: 1px solid rgba(239, 68, 68, 0.3);
      }

      .status-voted {
        background: rgba(88, 101, 242, 0.15);
        color: var(--discord-blurple);
        border: 1px solid rgba(88, 101, 242, 0.3);
      }

      /* Stats */
      .stats {
        display: flex;
        justify-content: center;
        gap: 3rem;
        margin-top: 2rem;
        flex-wrap: wrap;
      }

      .stat {
        text-align: center;
      }

      .stat-value {
        font-size: 2.25rem;
        font-weight: 700;
        color: var(--text-white);
        display: block;
      }

      .stat-label {
        font-size: 0.8125rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-top: 0.25rem;
      }

      /* Voting info banner */
      .voting-banner {
        background: var(--bg-card);
        border: 1px solid var(--border-dark);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        text-align: center;
      }

      .voting-banner h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-white);
        margin-bottom: 0.5rem;
      }

      .voting-banner p {
        color: var(--text-muted);
        font-size: 0.9375rem;
      }

      .voting-period {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255, 107, 53, 0.1);
        color: var(--primary-orange);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        margin-top: 1rem;
        font-size: 0.875rem;
      }

      /* Loading */
      .loading {
        text-align: center;
        padding: 4rem 2rem;
        font-size: 1rem;
        color: var(--text-muted);
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-dark);
        border-top-color: var(--primary-orange);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Error */
      .error {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        color: var(--error);
      }

      /* Projects grid */
      .projects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 1.5rem;
      }

      .project-card {
        background: var(--bg-card);
        border: 1px solid var(--border-dark);
        border-radius: 16px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .project-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--gradient-warm);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .project-card:hover {
        background: var(--bg-card-hover);
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
      }

      .project-card:hover::before {
        opacity: 1;
      }

      .project-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .project-avatar {
        width: 52px;
        height: 52px;
        border-radius: 12px;
        background: var(--gradient-warm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1.25rem;
        color: white;
        flex-shrink: 0;
      }

      .project-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 12px;
      }

      .project-name {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-white);
        margin-bottom: 0.125rem;
      }

      .project-slug {
        font-size: 0.8125rem;
        color: var(--text-muted);
      }

      .project-description {
        color: var(--text-muted);
        line-height: 1.6;
        margin-bottom: 1rem;
        font-size: 0.9375rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .project-meta {
        display: flex;
        gap: 1.5rem;
        margin-bottom: 1rem;
        padding: 1rem 0;
        border-top: 1px solid var(--border-dark);
        border-bottom: 1px solid var(--border-dark);
      }

      .meta-item {
        display: flex;
        flex-direction: column;
      }

      .meta-label {
        font-size: 0.6875rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .meta-value {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-white);
        margin-top: 0.125rem;
      }

      .project-tags {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
      }

      .tag {
        font-size: 0.6875rem;
        padding: 0.25rem 0.625rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-dark);
        border-radius: 4px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }

      .project-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .project-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        color: var(--text-muted);
        text-decoration: none;
        font-size: 0.8125rem;
        transition: color 0.2s ease;
      }

      .project-link:hover {
        color: var(--primary-orange);
      }

      .vote-count {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        color: var(--text-muted);
        font-size: 0.875rem;
      }

      .vote-count strong {
        color: var(--text-white);
      }

      /* Results section */
      .results-section {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border-dark);
      }

      .results-section h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-white);
        margin-bottom: 1.5rem;
        text-align: center;
      }

      .results-list {
        max-width: 600px;
        margin: 0 auto;
      }

      .result-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: var(--bg-card);
        border: 1px solid var(--border-dark);
        border-radius: 12px;
        margin-bottom: 0.75rem;
      }

      .result-rank {
        width: 32px;
        height: 32px;
        background: var(--gradient-warm);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.875rem;
        color: white;
        flex-shrink: 0;
      }

      .result-rank.rank-2 {
        background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
      }

      .result-rank.rank-3 {
        background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
      }

      .result-info {
        flex: 1;
      }

      .result-name {
        font-weight: 600;
        color: var(--text-white);
      }

      .result-votes {
        font-size: 0.875rem;
        color: var(--text-muted);
      }

      .result-bar {
        height: 4px;
        background: var(--border-dark);
        border-radius: 2px;
        margin-top: 0.5rem;
        overflow: hidden;
      }

      .result-bar-fill {
        height: 100%;
        background: var(--gradient-warm);
        border-radius: 2px;
        transition: width 0.5s ease;
      }

      /* Toast notifications */
      .toast {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--bg-card);
        border: 1px solid var(--border-dark);
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }

      .toast.success {
        border-color: var(--success);
      }

      .toast.error {
        border-color: var(--error);
      }

      /* No projects */
      .no-projects {
        text-align: center;
        padding: 4rem 2rem;
        font-size: 1rem;
        color: var(--text-muted);
      }

      /* Responsive */
      @media (max-width: 768px) {
        h1 {
          font-size: 2rem;
        }

        .stats {
          gap: 1.5rem;
        }

        .projects-grid {
          grid-template-columns: 1fr;
        }

        .project-meta {
          gap: 1rem;
        }

        .user-section {
          flex-direction: column;
        }
      }

      /* Discord icon */
      .discord-icon {
        width: 20px;
        height: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo-section">
          <div class="logo">üèóÔ∏è</div>
          <h1>Construct Community</h1>
        </div>
        <p class="subtitle">Vote to allocate funds to your favorite projects</p>
        
        <div class="user-section" id="user-section">
          <!-- User info or login button will be inserted here -->
        </div>

        <div class="stats">
          <div class="stat">
            <span class="stat-value" id="project-count">‚Äî</span>
            <span class="stat-label">Active Projects</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="total-balance">‚Äî</span>
            <span class="stat-label">Total Balance</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="vote-count">‚Äî</span>
            <span class="stat-label">Votes This Month</span>
          </div>
        </div>
      </header>

      <div class="voting-banner" id="voting-banner">
        <h2>üó≥Ô∏è Monthly Project Vote</h2>
        <p>Eligible members can vote once per month to allocate community funds to a project.</p>
        <div class="voting-period" id="voting-period">
          <!-- Current month will be inserted -->
        </div>
      </div>

      <div id="content">
        <div class="loading">
          <div class="loading-spinner"></div>
          Loading projects...
        </div>
      </div>

      <div class="results-section" id="results-section" style="display: none;">
        <h2>üìä Current Month Results</h2>
        <div class="results-list" id="results-list">
          <!-- Results will be inserted here -->
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
      const API_ENDPOINT = 'https://api.opencollective.com/graphql/v2';
      const COLLECTIVE_SLUG = 'construct-community';

      let currentUser = null;
      let hasVotedThisMonth = false;
      let monthlyResults = {};

      // Initialize
      document.addEventListener('DOMContentLoaded', async () => {
        updateVotingPeriod();
        await checkAuth();
        await Promise.all([
          fetchProjects(),
          fetchVoteResults()
        ]);
      });

      function updateVotingPeriod() {
        const now = new Date();
        const monthName = now.toLocaleString('default', { month: 'long', year: 'numeric' });
        document.getElementById('voting-period').innerHTML = `üìÖ Voting Period: ${monthName}`;
      }

      async function checkAuth() {
        try {
          const response = await fetch('/api/me');
          const data = await response.json();
          
          if (data.authenticated) {
            currentUser = data.user;
            hasVotedThisMonth = data.hasVotedThisMonth;
            renderUserSection();
          } else {
            renderLoginButton();
          }
        } catch (err) {
          console.error('Auth check failed:', err);
          renderLoginButton();
        }
      }

      function renderLoginButton() {
        const userSection = document.getElementById('user-section');
        userSection.innerHTML = `
          <a href="/auth/discord" class="btn btn-discord">
            <svg class="discord-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
            </svg>
            Connect with Discord
          </a>
        `;
      }

      function renderUserSection() {
        const userSection = document.getElementById('user-section');
        const avatarUrl = currentUser.avatar 
          ? `https://cdn.discordapp.com/avatars/${currentUser.id}/${currentUser.avatar}.png`
          : null;
        
        let statusBadge = '';
        if (!currentUser.isGuildMember) {
          statusBadge = `<span class="status-badge status-ineligible">‚ö†Ô∏è Not a server member</span>`;
        } else if (!currentUser.hasRequiredRole) {
          statusBadge = `<span class="status-badge status-ineligible">‚ö†Ô∏è Missing required role</span>`;
        } else if (hasVotedThisMonth) {
          statusBadge = `<span class="status-badge status-voted">‚úì Voted this month</span>`;
        } else {
          statusBadge = `<span class="status-badge status-eligible">‚úì Eligible to vote</span>`;
        }
        
        userSection.innerHTML = `
          <div class="user-info">
            <div class="user-avatar">
              ${avatarUrl ? `<img src="${avatarUrl}" alt="${currentUser.username}">` : currentUser.username.charAt(0).toUpperCase()}
            </div>
            <span class="user-name">${currentUser.username}</span>
          </div>
          ${statusBadge}
          <button class="btn btn-logout" onclick="logout()">Logout</button>
        `;
      }

      async function logout() {
        try {
          await fetch('/auth/logout', { method: 'POST' });
          currentUser = null;
          hasVotedThisMonth = false;
          renderLoginButton();
          // Re-render projects to remove vote buttons
          const contentDiv = document.getElementById('content');
          const projects = contentDiv.querySelector('.projects-grid');
          if (projects) {
            await fetchProjects();
          }
        } catch (err) {
          console.error('Logout failed:', err);
        }
      }

      async function fetchProjects() {
        const query = `
          query($slug: String!) {
            account(slug: $slug) {
              name
              slug
              description
              imageUrl
              stats {
                balance {
                  valueInCents
                  currency
                }
              }
              childrenAccounts(accountType: PROJECT, isActive: true) {
                totalCount
                nodes {
                  id
                  name
                  slug
                  description
                  imageUrl
                  tags
                  isActive
                  isArchived
                  createdAt
                  stats {
                    balance {
                      valueInCents
                      currency
                    }
                    totalAmountReceived {
                      valueInCents
                      currency
                    }
                  }
                  members(role: BACKER) {
                    totalCount
                  }
                }
              }
            }
          }
        `;

        try {
          const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              query,
              variables: { slug: COLLECTIVE_SLUG }
            })
          });

          const result = await response.json();

          if (result.errors) {
            throw new Error(result.errors[0].message);
          }

          renderProjects(result.data.account);
        } catch (error) {
          console.error('Error fetching projects:', error);
          showError(error);
        }
      }

      async function fetchVoteResults() {
        try {
          const response = await fetch('/api/votes/current');
          const data = await response.json();
          monthlyResults = data.results;
          updateVoteCount();
          renderResults();
        } catch (err) {
          console.error('Error fetching vote results:', err);
        }
      }

      function updateVoteCount() {
        const totalVotes = Object.values(monthlyResults).reduce((sum, p) => sum + p.count, 0);
        document.getElementById('vote-count').textContent = totalVotes;
      }

      function formatCurrency(valueInCents, currency) {
        const value = valueInCents / 100;
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: currency || 'USD',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(value);
      }

      function getInitials(name) {
        return name
          .split(' ')
          .map(word => word[0])
          .slice(0, 2)
          .join('')
          .toUpperCase();
      }

      function renderProjects(accountData) {
        const contentDiv = document.getElementById('content');
        const projects = accountData.childrenAccounts.nodes;

        // Update stats
        document.getElementById('project-count').textContent = projects.length;

        const totalBalance = projects.reduce((sum, p) => {
          return sum + (p.stats?.balance?.valueInCents || 0);
        }, 0);
        document.getElementById('total-balance').textContent = formatCurrency(totalBalance, 'USD');

        if (projects.length === 0) {
          contentDiv.innerHTML = '<div class="no-projects">No active projects found.</div>';
          return;
        }

        const projectsHTML = projects.map(project => {
          const balance = project.stats?.balance?.valueInCents || 0;
          const currency = project.stats?.balance?.currency || 'USD';
          const totalReceived = project.stats?.totalAmountReceived?.valueInCents || 0;
          const backers = project.members?.totalCount || 0;
          const tags = project.tags || [];
          const projectVotes = monthlyResults[project.slug]?.count || 0;

          const canVote = currentUser?.hasRequiredRole && !hasVotedThisMonth;
          
          let voteButton = '';
          if (currentUser) {
            if (hasVotedThisMonth) {
              voteButton = `<button class="btn btn-vote btn-voted" disabled>‚úì Voted</button>`;
            } else if (currentUser.hasRequiredRole) {
              voteButton = `<button class="btn btn-vote" onclick="vote('${project.slug}', '${project.name.replace(/'/g, "\\'")}')">Vote for this</button>`;
            }
          }

          return `
            <div class="project-card">
              <div class="project-header">
                <div class="project-avatar">
                  ${project.imageUrl 
                    ? `<img src="${project.imageUrl}" alt="${project.name}">`
                    : getInitials(project.name)
                  }
                </div>
                <div class="project-info">
                  <div class="project-name">${project.name}</div>
                  <div class="project-slug">@${project.slug}</div>
                </div>
              </div>
              
              ${project.description 
                ? `<div class="project-description">${project.description}</div>`
                : ''
              }
              
              <div class="project-meta">
                <div class="meta-item">
                  <span class="meta-label">Balance</span>
                  <span class="meta-value">${formatCurrency(balance, currency)}</span>
                </div>
                <div class="meta-item">
                  <span class="meta-label">Received</span>
                  <span class="meta-value">${formatCurrency(totalReceived, currency)}</span>
                </div>
                <div class="meta-item">
                  <span class="meta-label">Backers</span>
                  <span class="meta-value">${backers}</span>
                </div>
              </div>

              ${tags.length > 0 ? `
                <div class="project-tags">
                  ${tags.slice(0, 3).map(tag => `<span class="tag">${tag}</span>`).join('')}
                </div>
              ` : ''}
              
              <div class="project-footer">
                <a href="https://opencollective.com/${project.slug}" 
                   target="_blank" 
                   rel="noopener noreferrer" 
                   class="project-link">
                  View on Open Collective ‚Üí
                </a>
                <div class="vote-count">
                  üó≥Ô∏è <strong>${projectVotes}</strong> vote${projectVotes !== 1 ? 's' : ''}
                </div>
              </div>
              
              ${voteButton ? `<div style="margin-top: 1rem;">${voteButton}</div>` : ''}
            </div>
          `;
        }).join('');

        contentDiv.innerHTML = `<div class="projects-grid">${projectsHTML}</div>`;
      }

      async function vote(projectSlug, projectName) {
        if (!currentUser || !currentUser.hasRequiredRole || hasVotedThisMonth) {
          return;
        }

        try {
          const response = await fetch('/api/vote', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ projectSlug, projectName })
          });

          const data = await response.json();

          if (response.ok) {
            hasVotedThisMonth = true;
            monthlyResults = data.results;
            showToast(`Successfully voted for ${projectName}!`, 'success');
            renderUserSection();
            await fetchProjects();
            updateVoteCount();
            renderResults();
          } else {
            showToast(data.error || 'Failed to record vote', 'error');
          }
        } catch (err) {
          console.error('Vote failed:', err);
          showToast('Failed to record vote. Please try again.', 'error');
        }
      }

      function renderResults() {
        const resultsSection = document.getElementById('results-section');
        const resultsList = document.getElementById('results-list');
        
        const sortedResults = Object.entries(monthlyResults)
          .map(([slug, data]) => ({ slug, ...data }))
          .sort((a, b) => b.count - a.count);

        if (sortedResults.length === 0) {
          resultsSection.style.display = 'none';
          return;
        }

        resultsSection.style.display = 'block';
        const maxVotes = sortedResults[0]?.count || 1;

        resultsList.innerHTML = sortedResults.map((result, index) => {
          const percentage = (result.count / maxVotes) * 100;
          let rankClass = '';
          if (index === 0) rankClass = '';
          else if (index === 1) rankClass = 'rank-2';
          else if (index === 2) rankClass = 'rank-3';
          else rankClass = 'rank-other';

          return `
            <div class="result-item">
              <div class="result-rank ${rankClass}">${index + 1}</div>
              <div class="result-info">
                <div class="result-name">${result.projectName}</div>
                <div class="result-votes">${result.count} vote${result.count !== 1 ? 's' : ''}</div>
                <div class="result-bar">
                  <div class="result-bar-fill" style="width: ${percentage}%"></div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      function showError(error) {
        const contentDiv = document.getElementById('content');
        contentDiv.innerHTML = `
          <div class="error">
            <h2>Error Loading Projects</h2>
            <p>${error.message}</p>
          </div>
        `;
      }

      function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type} show`;
        
        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      }

      // Check for OAuth errors in URL
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('error')) {
        const error = urlParams.get('error');
        let message = 'Authentication failed';
        if (error === 'oauth_denied') message = 'Discord authorization was denied';
        else if (error === 'token_error') message = 'Failed to get access token';
        else if (error === 'oauth_error') message = 'OAuth authentication error';
        
        showToast(message, 'error');
        // Clean URL
        window.history.replaceState({}, document.title, '/');
      }
    </script>
  </body>
</html>

